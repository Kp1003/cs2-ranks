name: Build and Release

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: |
        cd Ranks
        dotnet restore Ranks.sln
        
    - name: Build Ranks solution
      run: |
        cd Ranks
        dotnet build Ranks.sln -c Release
        
    - name: Publish main Ranks project
      run: |
        cd Ranks/Ranks
        dotnet publish -c Release -o ../../publish --no-build
    
    - name: Package release
      run: |
        mkdir -p release-package/Ranks
        
        # Copy main Ranks plugin
        cp publish/Ranks.dll release-package/Ranks/
        cp publish/Ranks.pdb release-package/Ranks/
        cp publish/RanksApi.dll release-package/Ranks/
        cp publish/RanksApi.pdb release-package/Ranks/
        cp publish/MySqlConnector.dll release-package/Ranks/
        cp publish/Dapper.dll release-package/Ranks/
        
        # Copy modules from their build folders
        mkdir -p release-package/Ranks/Modules
        
        # FakeRank
        if [ -d "Ranks/Modules/Ranks_FakeRank/bin/Release/net8.0" ]; then
          mkdir -p release-package/Ranks/Modules/Ranks_FakeRank
          cp Ranks/Modules/Ranks_FakeRank/bin/Release/net8.0/*.dll release-package/Ranks/Modules/Ranks_FakeRank/ || true
          cp Ranks/Modules/Ranks_FakeRank/bin/Release/net8.0/*.pdb release-package/Ranks/Modules/Ranks_FakeRank/ || true
        fi
        
        # ExStats GeoIP
        if [ -d "Ranks/Modules/Ranks_ExStats_GeoIP/bin/Release/net8.0" ]; then
          mkdir -p release-package/Ranks/Modules/Ranks_ExStats_GeoIP
          cp Ranks/Modules/Ranks_ExStats_GeoIP/bin/Release/net8.0/*.dll release-package/Ranks/Modules/Ranks_ExStats_GeoIP/ || true
          cp Ranks/Modules/Ranks_ExStats_GeoIP/bin/Release/net8.0/*.pdb release-package/Ranks/Modules/Ranks_ExStats_GeoIP/ || true
        fi
        
        # ExStats Hits
        if [ -d "Ranks/Modules/Ranks_ExStats_Hits/bin/Release/net8.0" ]; then
          mkdir -p release-package/Ranks/Modules/Ranks_ExStats_Hits
          cp Ranks/Modules/Ranks_ExStats_Hits/bin/Release/net8.0/*.dll release-package/Ranks/Modules/Ranks_ExStats_Hits/ || true
          cp Ranks/Modules/Ranks_ExStats_Hits/bin/Release/net8.0/*.pdb release-package/Ranks/Modules/Ranks_ExStats_Hits/ || true
        fi
        
        # Tag
        if [ -d "Ranks/Modules/Ranks_Tag/bin/Release/net8.0" ]; then
          mkdir -p release-package/Ranks/Modules/Ranks_Tag
          cp Ranks/Modules/Ranks_Tag/bin/Release/net8.0/*.dll release-package/Ranks/Modules/Ranks_Tag/ || true
          cp Ranks/Modules/Ranks_Tag/bin/Release/net8.0/*.pdb release-package/Ranks/Modules/Ranks_Tag/ || true
        fi
        
        # Copy config example if exists
        if [ -f Ranks/ranks.json ]; then
          cp Ranks/ranks.json release-package/Ranks/ranks_example.json
        fi
        
    - name: Create README
      run: |
        cat > release-package/README.txt << EOF
        CS2-Ranks with FakeRank Fix
        
        Installation:
        1. Copy the Ranks folder to /addons/counterstrikesharp/plugins/
        2. Configure ranks.json in the Ranks folder
        3. Restart server
        
        This is a fork with FakeRank scoreboard display fixed.
        Original: https://github.com/partiusfabaa/cs2-ranks
        EOF
        
    - name: Create ZIP
      run: |
        cd release-package
        zip -r ../cs2-ranks-fakerank-fix.zip *
        
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'release'
      with:
        files: cs2-ranks-fakerank-fix.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}